{% extends 'index.html' %} {% block content %} {% load staticfiles %}

<div class="content-wrapper">
    <div class="container-xxl flex-grow-1 container-p-y">
        <h4 class="fw-bold py-3 mb-4"><span class="text-muted fw-light">Inventory /</span> List</h4>

        <div class="card">
            <div class="card-body">
                <div class="card-datatable text-nowrap">
                    <table id="tbl-items" class="table display compact">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Item Type</th>
                                <th>Item Description</th>
                                <th>Method</th>
                                <th>Days</th>
                                <th>Total Quantity</th>
                                {% for row in location %}
                                <th class="text-center">{{ row.name }}</th>
                                {% endfor %}
                                <th>Unit Price</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="modalLocation" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <form id="frm-location">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalLocationTitle">Update Stock Location</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Item Name: <span id="modal-stock-details" class="fw-bold"></span></p>
                        <div class="row my-4">
                            <div id="modal-error-message" style="display: none" class="col-md-12">
                                <div class="alert alert-danger d-flex align-items-center" role="alert">
                                    <span class="alert-icon text-danger me-2">
                                        <i class="ti ti-ban ti-xs"></i>
                                    </span>
                                    <span id="modal-error-message-text"></span>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <label class="form-label" for="modal-po">PO Number</label>
                                <select id="modal-po" name="po" class="form-select" data-allow-clear="true">
                                    <option></option>
                                </select>
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <label class="form-label" for="modal-from-location">From Location</label>
                                <select id="modal-from-location" name="from_location" class="form-select" data-allow-clear="true">
                                    <option></option>
                                    {% for row in location %}
                                    <option value="{{ row.id }}">{{ row.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <label class="form-label" for="modal-to-location">To Location</label>
                                <select id="modal-to-location" name="to_location" class="form-select" data-allow-clear="true">
                                    <option></option>
                                    {% for row in location %}
                                    <option value="{{ row.id }}">{{ row.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <label for="modal-qty-location" class="form-label">Quantity</label>
                                <input type="number" class="form-control" name="transfer_quantity" id="modal-qty-location" />
                            </div>
                        </div>
                        <table id="modal-tbl-locations" class="table display compact">
                            <thead>
                                <tr>
                                    <th class="text-center">Purchase Order</th>
                                    <th class="text-center">Quantity</th>
                                    {% for row in location %}
                                    <th class="text-center">{{ row.name }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tfoot>
                                <tr>
                                    <td class="fw-bold">Total</td>
                                    <td><span id="modal-stock-total-qty" class="badge bg-secondary"></span></td>
                                    {% for row in location %}
                                    <td>
                                        <span id="modal-stock-location-qty-{{ row.name }}" class="badge bg-secondary"></span>
                                    </td>
                                    {% endfor %}
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-label-secondary" data-bs-dismiss="modal">Close</button>
                        <button name="submitButton" class="btn btn-primary">Save changes</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div class="modal fade" id="modalStockBalance" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered" style="min-width: 90%" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalCenterTitle">Stock Balance</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6>Item details: <span id="modal-item-details"></span><h6>
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered display compact">
                            <thead class="table-light text-center">
                                <tr>
                                    <th rowspan="2">Date</th>
                                    <th rowspan="2">Reference Code</th>
                                    <th colspan="3">In</th>
                                    <th colspan="3">Out</th>
                                    <th colspan="3">Balance</th>
                                </tr>
                                <tr>
                                    <th>Quantity</th>
                                    <th>Cost</th>
                                    <th>Total</th>
                                    <th>Quantity</th>
                                    <th>Cost</th>
                                    <th>Total</th>
                                    <th>Quantity</th>
                                    <th>Cost</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="stock-balance-field"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %} {% block footer_scripts %}
<script>
    var csrftoken = getCookie('csrftoken');

    const toast_options = (toastr.options = {
        maxOpened: 1,
        autoDismiss: true,
        closeButton: true,
        newestOnTop: true,
        progressBar: true,
        positionClass: 'toast-top-right',
        rtl: isRtl,
    })
    $(document).ready(function () {
        const table_items = $('#tbl-items')
        const modal_stock_details = $('#modal-stock-details')
        const modal_tbl_locations = $('#modal-tbl-locations')
        const modal_stock_total_qty = $('#modal-stock-total-qty')
        const modal_stock_location_qty = $('#modal-stock-location-qty')
        const frm_location = document.getElementById('frm-location')
        const po = jQuery(document.querySelector('[name="po"]'))
        const from_location = jQuery(document.querySelector('[name="from_location"]'))
        const to_location = jQuery(document.querySelector('[name="to_location"]'))
        const transfer_quantity = jQuery(document.querySelector('[name="transfer_quantity"]'))
        const modal_error_message = $('#modal-error-message')
        const modal_error_message_text = $('#modal-error-message-text')

        let columns_data_1 = [{ data: 'id' }, { data: 'item_type_name' }, { data: 'details' }, {data: 'expired_count'}, {data: 'date_diff'}, { data: 'pcs_quantity' }]

        {% for l in location %}
            columns_data_1.push({
                data: '{{ l.name }}',
            })
        {% endfor %}

        columns_data_1.push({
            data: 'unit_price',
        })

        var stocksTable = table_items.DataTable({
            processing: true,
            serverSide: true,
            ajax: {
                url: "{% url 'inventory-load' %}",
            },
            columns: columns_data_1,
            columnDefs: [
                {
                    targets: 0,
                    title: 'Actions',
                    orderable: false,
                    searchable: false,
                    render: function (data, type, row) {
                        let id = data.toString()
                        return `<a href="javascript:;" class="stock-location text-body" data-item="${row['details']}" data-id="${row['id']}"><i class="text-secondary ti ti-map-pin"></i></a>
                                <a href="javascript:;" class="stock-balance text-body" data-id=${data}  data-item="${row['details']}"><i class="text-primary ti ti-versions"></i></a>`
                    },
                },
                {
                    targets: 2,
                    orderable: false,
                    searchable: false,
                },
                {
                    targets: 3,
                    orderable: false,
                    searchable: false,
                    render: function (data) {
                        if (data > 0) {
                            return `<span class="badge bg-danger">Expiry</span>`
                        } else {
                            return `<span class="badge bg-secondary">FIFO</span>`
                        }
                    },
                },
                {
                    targets: 4,
                    orderable: false,
                    searchable: false,
                    render: function (data, type, row) {
                        if(row['expired_count'] == 1) {
                            return `<span class="badge bg-label-danger">${data}</span>`
                        } else {
                            return ''
                        }
                    },
                },
                {
                    targets: 5,
                    orderable: false,
                    searchable: false,
                    render: function (data) {
                        return `<span class="badge bg-primary">${data}</span>`
                    },
                },
                {% for l in location %}
                    {
                        targets: ({{ forloop.counter }} + 5),
                        orderable: false,
                        searchable: false,
                        render: function (data, type, row) {
                            return `<span class="badge bg-label-primary">${data}</span>`;
                        },
                    },
                {% endfor %}
                {
                    targets: -1,
                    render: function (data) {
                        let elem = ''
                        if (data) {
                            elem = `<span class="badge bg-label-secondary">${currencyFormat(data)}</span>`
                        }
                        return elem
                    },
                },
            ],
            order: [[1, 'asc']],
            scrollX: true,
            drawCallback: function (settings) {
                $('.stock-location').on('click', function () {
                    const item_details = $(this).data('item')
                    const item_id = $(this).data('id')
                    let po_number = []

                    modal_stock_details.text(item_details)

                    $('#modalLocation').modal('show')

                    let columns_data = [{ data: 'code' }, { data: 'stock_item__pcs_quantity' }]

                    {% for l in location %}
                        columns_data.push({
                            data: '{{ l.name }}',
                        })
                    {% endfor %}

                    const fv = FormValidation.formValidation(frm_location, {
                        fields: {
                            po: {
                                validators: {
                                    notEmpty: {
                                        message: 'Please select po',
                                    },
                                },
                            },
                            from_location: {
                                validators: {
                                    notEmpty: {
                                        message: 'Please select from location',
                                    },
                                },
                            },
                            to_location: {
                                validators: {
                                    notEmpty: {
                                        message: 'Please select to location',
                                    },
                                },
                            },
                            transfer_quantity: {
                                validators: {
                                    notEmpty: {
                                        message: 'Please enter quantity',
                                    },
                                },
                            },
                        },
                        plugins: {
                            trigger: new FormValidation.plugins.Trigger(),
                            bootstrap5: new FormValidation.plugins.Bootstrap5(),
                            submitButton: new FormValidation.plugins.SubmitButton(),
                            autoFocus: new FormValidation.plugins.AutoFocus(),
                        },
                        init: (instance) => {
                            instance.on('plugins.message.placed', function (e) {
                                if (e.element.parentElement.classList.contains('form-group')) {
                                    e.element.parentElement.insertAdjacentElement('afterend', e.messageElement)
                                }
                                if (e.element.parentElement.parentElement.classList.contains('custom-option')) {
                                    e.element.closest('.row').insertAdjacentElement('afterend', e.messageElement)
                                }
                            })
                        },
                    }).on('core.form.valid', function () {
                        let selected_from_location = po_number.filter(i => i.id == po.val())[0]
                        let based_location = ''
                        let selected_location_val = 0
                        {% for l in location %}
                            if (from_location.val() == {{ l.id }}) {
                                selected_location_val = selected_from_location['{{ l.name }}']
                                based_location = '{{ l.name }}'
                            }
                        {% endfor %}
                        if (transfer_quantity.val() > selected_location_val) {
                            modal_error_message_text.text(`The quantity exceeds the total quantity of based location ${based_location}!`)
                            modal_error_message.show()
                            return false
                        }
                        modal_error_message_text.text()
                        modal_error_message.hide()
                        Swal.fire({
                            title: 'Are you sure?',
                            text: "You won't be able to revert this!",
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'Yes, save it!',
                            customClass: {
                                confirmButton: 'btn btn-primary me-3',
                                cancelButton: 'btn btn-label-secondary',
                            },
                            buttonsStyling: false,
                        }).then(function (result) {
                            if (result.value) {
                                var form_data = $('#frm-location').serialize()
                                $.ajax({
                                    type: 'POST',
                                    url: "{% url 'update-stock-locations' %}",
                                    data: form_data,
                                     headers: {
                                        'X-CSRFToken': csrftoken,
                                    },
                                }).done(function (data) {
                                    if (data.data == 'success') {
                                        Swal.fire({
                                            icon: 'success',
                                            title: 'Successfully save!',
                                            text: 'Location has been updated.',
                                            customClass: {
                                                confirmButton: 'btn btn-success',
                                            },
                                        })
                                        transfer_quantity.val(0)
                                        modal_tbl_locations.DataTable().ajax.reload();
                                        table_items.DataTable().ajax.reload()
                                        toastr.success('Item location updated', 'Success', toast_options)
                                    } else {
                                        Swal.fire({
                                            icon: 'error',
                                            title: 'Error saving!',
                                            text: 'Encountered error on saving location!',
                                            customClass: {
                                                confirmButton: 'btn btn-success',
                                            },
                                        })
                                    }
                                })
                            }
                        })
                    })

                    modal_tbl_locations.DataTable({
                        processing: true,
                        serverSide: true,
                        searching: false,
                        destroy: true,
                        info: false,
                        ordering: false,
                        paging: false,
                        ajax: {
                            url: "{% url 'get-stock-locations' %}?id=" + item_id,
                        },
                        columns: columns_data,
                        columnDefs: [
                            {
                                targets: 0,
                                render: function (data, type, row) {
                                    let po_data = {
                                        id: row.stock_item__id,
                                        text: data
                                    }

                                    {% for l in location %}
                                        po_data['{{ l.name }}'] = row.{{ l.name }}
                                    {% endfor %}

                                    po_number.push(po_data)
                                    return `<span class="badge bg-label-primary">${data}</span>`;
                                },
                            },
                            {
                                targets: 1,
                                render: function (data) {
                                    return `<span class="row-total-qty badge bg-label-secondary">${data}</span>`;
                                },
                            },

                            {% for l in location %}
                                {
                                    targets: ({{ forloop.counter }} + 1),
                                    render: function (data, type, row) {
                                        return `<span class="row-total-qty-{{ l.name }} badge bg-label-success">${data}</span>`;
                                    },
                                },
                            {% endfor %}
                        ],
                        drawCallback: function (settings) {
                            const row_total_qty = $('.row-total-qty')
                            let total_qty = 0

                            // Select2 (po)
                            if (po.length) {
                                po.wrap('<div class="position-relative"></div>')
                                po.select2({
                                    placeholder: 'Select Purchase Order',
                                    dropdownParent: po.parent(),
                                    minimumResultsForSearch: -1,
                                }).on('change.select2', function () {
                                    // Revalidate the color field when an option is chosen
                                    fv.revalidateField('po')
                                })
                            }


                            po.empty();
                            po_number.forEach(e => {
                                var newOption = new Option(e.text, e.id, false, false);
                                po.append(newOption).trigger('change');
                            })


                            row_total_qty.each(function() {
                                total_qty += parseInt($(this).text());
                            })

                            modal_stock_total_qty.text(total_qty)

                            {% for l in location %}
                                const location_data_{{ l.name }} = $('.row-total-qty-{{ l.name }}')
                                let total_qty_{{ l.name }} = 0

                                location_data_{{ l.name }}.each(function() {
                                    total_qty_{{ l.name }} += parseInt($(this).text());
                                })

                                $('#modal-stock-location-qty-{{ l.name }}').text(total_qty_{{ l.name }});
                            {% endfor %}

                        },
                    })


                    // Select2 (from_location)
                    if (from_location.length) {
                        from_location.wrap('<div class="position-relative"></div>')
                        from_location.select2({
                            placeholder: 'Select From Location',
                            dropdownParent: from_location.parent(),
                            minimumResultsForSearch: -1
                        }).on('change.select2', function () {
                            fv.revalidateField('from_location')
                            var select_val = from_location.val();
                            $.each(to_location.options, function (i, item) {
                                if (item.selected) {
                                    $(item).prop("disabled", true);
                                }
                            });
                        })
                    }

                    // Select2 (to_location)
                    if (to_location.length) {
                        to_location.wrap('<div class="position-relative"></div>')
                        to_location.select2({
                            placeholder: 'Select To Location',
                            dropdownParent: to_location.parent(),
                            minimumResultsForSearch: -1
                        }).on('change.select2', function () {
                            fv.revalidateField('to_location')
                        })
                    }

                })

                $('.stock-balance').on('click', function() {
                    const modal_stock_balance = $('#modalStockBalance')
                    const stock_balance_field = $('#stock-balance-field')
                    const modal_item_details = $('#modal-item-details')
                    let item_id = $(this).data('id')
                    let item_details = $(this).data('item')

                    $.ajax({
                        type: 'GET',
                        url: "{% url 'inventory-stock-balance' %}",
                        data: {id: item_id},
                    }).done(function (data) {
                        if (data.length > 0) {
                            toastr.success('Success fetching data!', 'Success', toast_options)
                            
                            let data_element = ''
                            modal_item_details.html(`<span class="badge bg-primary">${item_details}</span>`)

                            data.forEach(e => {
                                if (e.trans_type == 'in') {
                                    data_element += `
                                        <tr>
                                            <th>${convertDateTime(e.trans_date)}</th>
                                            <th>${e.code}</th>
                                            <th class="text-right">${e.quantity}</th>
                                            <th class="text-right">${currencyFormat(e.cost)}</th>
                                            <th class="text-right">${Number(e.total).toFixed(2)}</th>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                            <th class="text-right">${e.balance_qty}</th>
                                            <th class="text-right">${currencyFormat(e.balance_cost ?? 0)}</th>
                                            <th class="text-right">${e.balance_total}</th>
                                        </tr>
                                    `
                                } else {
                                    data_element += `
                                        <tr>
                                            <th>${convertDateTime(e.trans_date)}</th>
                                            <th>${e.code}</th>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                            <th class="text-right">${e.quantity}</th>
                                            <th class="text-right">${currencyFormat(e.cost)}</th>
                                            <th class="text-right">${Number(e.total).toFixed(2)}</th>
                                            <th class="text-right">${e.balance_qty}</th>
                                            <th class="text-right">${currencyFormat(e.balance_cost ?? 0)}</th>
                                            <th class="text-right">${e.balance_total}</th>
                                        </tr>
                                    `
                                }

                            })

                            stock_balance_field.html(data_element)

                            modal_stock_balance.modal('show')

                        } else {
                            toastr.danger('Error fetching data!', 'Error', toast_options)
                        }
                    })
                })
            }
        })

    })
</script>
{% endblock footer_scripts %}
