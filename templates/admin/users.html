{% extends 'index.html' %} {% block content %} {% load staticfiles %}

<!-- Content wrapper -->
<div class="content-wrapper">
    <!-- Content -->
    <div class="container-fluid flex-grow-1 container-p-y">
        <h4 class="fw-bold py-3 mb-4"><span class="text-muted fw-light">Users /</span> List</h4>

        <!-- DataTable with Buttons -->
        <div class="card">
            <div class="card-datatable table-responsive pt-0">
                <table id="tbl-items" class="table">
                    <thead>
                        <tr>
                            
                            <th>Username</th>
                            <th>Firstname</th>
                            <th>Lastname</th>
                            <th>Position</th>
                            <th>Email</th>
                            <th>Birthdate</th>
                            <th>Sex</th>
                            <th>Address</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Action</th>
                          
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

      <!-- Modal to add new record -->
<div class="offcanvas offcanvas-end" id="add-new-record">
    <div class="offcanvas-header border-bottom">
        <h5 class="offcanvas-title" id="exampleModalLabel"><p class="title-name">Add Record</p></h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body flex-grow-1">
        <form class="add-new-record pt-0 row g-2" id="item-form">
            <input type="hidden" id="item-id" name="ItemID" />
            <div class="col-sm-12">
                <label class="form-label" for="Firstname">First Name</label>
                <div class="input-group input-group-merge">
                  <span id="username2" class="input-group-text"><i class="ti ti-user"></i></span>
                  <input
                    type="text"
                    id="firstname"
                    class="form-control dt-first-name"
                    name="Firstname"
                    placeholder="Enter firstname"
                    aria-describedby="firstname2"
                  />
                </div>
              </div>
      
              <div class="col-sm-12">
                <label class="form-label" for="Middlename">Middle Name</label>
                <div class="input-group input-group-merge">
                  <span id="middlename2" class="input-group-text"><i class="ti ti-user"></i></span>
                  <input
                    type="text"
                    id="middlename"
                    class="form-control dt-middle-name"
                    name="Middlename"
                    placeholder="Enter Middlename"
                    aria-describedby="middlename2"
                  />
                </div>
              </div>
      
              <div class="col-sm-12">
                  <label class="form-label" for="Lastname">Last Name</label>
                  <div class="input-group input-group-merge">
                    <span id="lastname2" class="input-group-text"><i class="ti ti-user"></i></span>
                    <input
                      type="text"
                      id="lastname"
                      class="form-control dt-last-name"
                      name="Lastname"
                      placeholder="Enter Lastname"
                      aria-describedby="lastname2"
                    />
                  </div>
              </div>
      
              <div class="col-sm-12">
                  <label class="form-label" for="Lastname">User Name</label>
                  <div class="input-group input-group-merge">
                    <span id="user2" class="input-group-text"><i class="ti ti-user"></i></span>
                    <input
                      type="text"
                      id="username"
                      class="form-control dt-user-name"
                      name="Username"
                      placeholder="Enter Username"
                      aria-describedby="user2"
                    />
                  </div>
              </div>
      
              <div class="col-sm-12 form-password-toggle">
                  <label class="form-label" for="Password" name="title-password" id="title-password">Password</label>
                  <div class="input-group input-group-merge">
                    <span id="password2" class="input-group-text"><i class="ti ti-user"></i></span>
                    
                    <input
                      type="password"
                      id="password"
                      class="form-control dt-password"
                      name="Password"
                      placeholder="&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;"
                      aria-describedby="password"
                    />
                      <span class="input-group-text cursor-pointer"><i class="ti ti-eye-off"></i></span>
                  </div>
              </div>
      
              <div class="col-sm-12 form-password-toggle">
                <label class="form-label" for="Confirm_password">Confirm password</label>
                <div class="input-group input-group-merge">
                  <span id="confirm_password2" class="input-group-text"><i class="ti ti-user"></i></span>
                  <input
                    type="password"
                    id="confirm_password"
                    class="form-control dt-confirm-password"
                    name="ConfirmPassword"
                    placeholder="&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;"
                    aria-describedby="confirm_password2"
                  />
                  <span class="input-group-text cursor-pointer"><i class="ti ti-eye-off"></i></span>
                </div>
            </div>
      
            <div class="col-sm-12 user-roles">
              <label class="form-label" for="status">Roles</label>
              <div class="input-group input-group-merge">
                <div class="col-12 col-xxl-12 col-xl-12">
                  <select class="select2 form-select dt-roles" name="Roles" id="roles">
                    <option></option>
                    {% for row in role_details %}
                    <option value="{{ row.id }}">{{ row.role_name }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div>
              
              <div class="col-sm-12 user-status">
                <label class="form-label" for="status">Status</label>
                <div class="input-group input-group-merge">
                    <div class="col-12 col-xxl-12 col-xl-12">
                      <select class="select2 form-select select-status" id="select" name="Status">
                        <option value="1">Active</option>
                        <option value="0">Inactive</option>
                      </select>
                    </div>
                </div>
              </div>

              <div class="col-sm-12 user-sex">
                <label class="form-label" for="Sex">Sex</label>
                <div class="input-group input-group-merge">
                    <div class="col-12 col-xxl-12 col-xl-12">
                      <select class="select2 form-select dt-sex" id="sex" name="Sex">
                        <option></option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                      </select>
                    </div>
      
                </div>
              </div>
      
              <div class="col-sm-12">
                <label class="form-label" for="Email">Email</label>
                <div class="input-group input-group-merge">
                  <span id="email2" class="input-group-text"><i class="ti ti-user"></i></span>
                  <input
                    type="text"
                    id="email"
                    class="form-control dt-email"
                    name="Email"
                    placeholder="Enter Email"
                    aria-describedby="email2"
                  />
                </div>
              </div>
      
              <div class="col-sm-12">
                <label class="form-label" for="Birthdate">Birthdate</label>
                <div class="input-group input-group-merge">
                  <span id="birthdate2" class="input-group-text"><i class="ti ti-user"></i></span>
                  <input
                    type="date"
                    id="birthdate"
                    class="form-control dt-birthdate"
                    name="Birthdate"
                    placeholder="Enter Birthdate"
                    aria-describedby="birthdate2"
                  />
                </div>
              </div>
    
              <div class="col-sm-12">
                <label class="form-label" for="Address">Address</label>
                <div class="input-group input-group-merge">
                  <span id="address2" class="input-group-text"><i class="ti ti-user"></i></span>
                  <input
                    type="text"
                    id="address"
                    class="form-control dt-address"
                    name="Address"
                    placeholder="Enter Address"
                    aria-describedby="address2"
                  />
                </div>
              </div>
      
              <div class="col-sm-12">
                <label class="form-label" for="Position">Position</label>
                <div class="input-group input-group-merge">
                  <span id="position2" class="input-group-text"><i class="ti ti-user"></i></span>
                  <input
                    type="text"
                    id="position"
                    class="form-control dt-position"
                    name="Position"
                    placeholder="Enter Position"
                    aria-describedby="position2"
                  />
                </div>
              </div>
      
      
              <div class="col-sm-12 update-div-user">
                <br>
                <button name="submitButton" class="btn btn-primary data-submit me-sm-3 me-1 additional-record">Submit</button>
                <button type="reset" class="btn btn-outline-secondary" data-bs-dismiss="offcanvas">Cancel</button>
              </div>
        </form>
    </div>
</div>

{% endblock %} {% block footer_scripts %}
<script>
    let clicked_id = 0;
    $(document).ready(function () {
        const table = $('#tbl-items')
        const ItemFormValidation = document.getElementById('item-form'),
            Firstname = jQuery(document.querySelector('[name="Firstname"]')),
            Middlename = jQuery(document.querySelector('[name="Middlename"]')),
            Lastname = jQuery(document.querySelector('[name="Lastname"]')),
            Username = jQuery(document.querySelector('[name="Username"]')),
            Password = jQuery(document.querySelector('[name="Password"]')),
            ConfirmPassword = jQuery(document.querySelector('[name="ConfirmPassword"]')),
            Roles = jQuery(document.querySelector('[name="Roles"]')),
            Email = jQuery(document.querySelector('[name="Email"]')),
            Birthdate = jQuery(document.querySelector('[name="Birthdate"]')),
            Sex = jQuery(document.querySelector('[name="Sex"]')),
            Address = jQuery(document.querySelector('[name="Address"]')),
            Position = jQuery(document.querySelector('[name="Position"]')),
            Status = jQuery(document.querySelector('[name="Status"]')),
            offCanvasElement = document.querySelector('#add-new-record');
        const offCanvasEl = new bootstrap.Offcanvas(offCanvasElement);
        const toast_options = (toastr.options = {
            maxOpened: 1,
            autoDismiss: true,
            closeButton: true,
            newestOnTop: true,
            progressBar: true,
            positionClass: 'toast-top-right',
            rtl: isRtl,
      });
        let ItemID = $('#item-id')

        let dataTable = table.DataTable({
            processing: true,
            serverSide: true,
            ajax: "{% url 'user-load' %}",
            columns: [
                { data: 'username' },
                { data: 'first_name'},
                { data: 'last_name' },
                { data: 'position' },
                { data: 'email' },
                { data: 'birthdate' },
                { data: 'sex' },
                { data: 'address' },
                { data: 'role_name' },
                { data: 'is_active' },
                { data: 'id' },
                
                // Additional columns
            ],
            columnDefs: [
                {
                    targets: 1,
                    render: function (data) {
                        return data
                    },
                },
                {
                  targets: 3,
                  render: function (data) {
                    return data
                  },
                },
                {
                    targets: -6,
                    render: function (data) {
                        return moment(data).format('LLL')
                    },
                },
                {
                    targets: -3,
                    render: function (data) {
                        if (data =="Management") {
                            return '<span class="badge bg-label-warning">'+data+'</span>'
                        }
                        else if(data =="Inventory Staff"){
                            return '<span class="badge bg-label-primary">'+data+'</span>'
                        }
                        else if(data =="Sales Staff"){
                            return '<span class="badge bg-label-info">'+data+'</span>'
                        }
                        else{
                            return '<span class="badge bg-label-success">'+data+'</span>'
                        }
                    },
                },
                {
                    targets: -2,
                    render: function (data) {
                        if (data) {
                            return '<span class="badge bg-label-success">Active</span>'
                        }
                        else{
                            return '<span class="badge bg-label-danger">Inactive</span>'
                        }
                    },
                },
                {
                  targets: -1,
                  title: 'Action',
                  orderable: false,
                  searchable: false,
                  render: function (data) {
                      return (
                          '<a href="javascript:;" data-id="' + data + '" class="item-edit text-body"><i class="text-primary ti ti-pencil"></i></a>'
                      )
                  },
              },
            ],
            dom: '<"card-header flex-column flex-md-row"<"head-label text-center"><"dt-action-buttons text-end pt-3 pt-md-0"B>><"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6 d-flex justify-content-center justify-content-md-end"f>>t<"row"<"col-sm-12 col-md-6"i><"col-sm-12 col-md-6"p>>',
            buttons: [
                {
                    text: '<i class="ti ti-plus me-sm-1"></i> <span class="d-none d-sm-inline-block">Add New Record</span>',
                    className: 'create-new btn btn-primary',
                },
            ],
            drawCallback: function (settings) {
                $('.item-edit').on('click', function () {
                    let id = $(this).data('id');
                    $('.user-status').show();
                    $('.title-name').text('Update User');
                    $('#title-password').text('New Password');
                    Password.val("");
                    ConfirmPassword.val("");

                    $.ajax({
                        type: 'GET',
                        url: "{% url 'user-edit' %}?id=" + id,
                        dataType: 'json',
                    }).done(function (data) {
                        if (data.length > 0) {
                            let fields = data[0].fields

                            console.log(fields);
                            let pk = data[0].pk
                            let user = $('#user')
        
                            Firstname.val(fields.first_name);
                            Middlename.val(fields.middle_name);
                            Lastname.val(fields.last_name);
                            Username.val(fields.username);
                            Roles.val(fields.role).trigger('change');
                            Status.val(fields.is_active === true ? 1 : 0).trigger('change');
                            Sex.val(fields.sex).trigger('change');
                            Email.val(fields.email);
                            Birthdate.val(fields.birthdate);
                            Address.val(fields.address);
                            Position.val(fields.position);
                            ItemID.val(pk)
                            offCanvasEl.show()
                        }
                    })
                }),
                $('.item-details').on('click', function () {
                    clicked_id = $(this).data('id')
                   // alert(id);

                })


            },
        })
        $('div.head-label').html('<h5 class="card-title mb-0">User</h5>')

        const newRecord = document.querySelector('.create-new')

        setTimeout(() => {
            if (newRecord) {
                newRecord.addEventListener('click', function () {
                    ItemID.val(0);
                    $('.user-status').hide();
                    $('.title-name').text('Add User');
                    $('#title-password').text('Password');
                    Firstname.val('').trigger('change');
                    $('.form-control').val('');
                    offCanvasEl.show();
                })
            }
        }, 200)

        // Form validation for Add new record
        const fv = FormValidation.formValidation(ItemFormValidation, {
            fields: {
                Firstname: {
                    validators: {
                        notEmpty: {
                            message: 'Please Enter Firstname',
                        },
                    },
                },
                Middlename: {
                    validators: {
                        notEmpty: {
                            message: 'Please Enter Middlename',
                        },
                    },
                },
                Lastname: {
                    validators: {
                        notEmpty: {
                            message: 'Please Enter Lastname',
                        },
                    },
                },
                Username: {
                    validators: {
                        notEmpty: {
                            message: 'Please Enter Username',
                        },
                    },
                },
                Password: {
                    validators: {
                        notEmpty: {
                            message: 'Please Enter Password',
                        },
                    },
                },
                ConfirmPassword: {
                    validators: {
                        notEmpty: {
                            message: 'Enter Confirm Password',
                        },
                    },
                },
                Roles: {
                    validators: {
                        notEmpty: {
                            message: 'Enter Roles',
                        },
                    },
                },
                Sex: {
                    validators: {
                        notEmpty: {
                            message: 'Enter Sex',
                        },
                    },
                },

            },
            plugins: {
                trigger: new FormValidation.plugins.Trigger(),
                bootstrap5: new FormValidation.plugins.Bootstrap5(),
                submitButton: new FormValidation.plugins.SubmitButton(),
                autoFocus: new FormValidation.plugins.AutoFocus(),
            },
            init: (instance) => {
                instance.on('plugins.message.placed', function (e) {
                    if (e.element.parentElement.classList.contains('input-group')) {
                        e.element.parentElement.insertAdjacentElement('afterend', e.messageElement)
                    }
                })
            },
        }).on('core.form.valid', function () {
            
            let password = Password.val();
            let confirmpassword = ConfirmPassword.val();
            if (password ==confirmpassword){
                Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, save it!',
                    customClass: {
                        confirmButton: 'btn btn-primary me-3',
                        cancelButton: 'btn btn-label-secondary',
                    },
                    buttonsStyling: false,
                }).then(function (result) {
                    if (result.value) {
                        var form_data = $('#item-form').serialize()
                        let post_url = ItemID.val() != '0' ? "{% url 'user-update' %}" : "{% url 'user-add' %}"
                        $.ajax({
                            type: 'POST',
                            url: post_url,
                            data: form_data,
                        }).done(function (data) {
                            if (data.data == 'success') {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Successfully save!',
                                    text: 'Item has been save.',
                                    customClass: {
                                        confirmButton: 'btn btn-success',
                                    },
                                })
                                offCanvasEl.hide()
                                dataTable.ajax.reload()
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error saving!',
                                    text: data.message,
                                    customClass: {
                                        confirmButton: 'btn btn-success',
                                    },
                                })
                            }
                        })
                    }
                });
            }
            else{
                toastr.error('Invalid', 'Password not match', toast_options);
            }
        });

        $('#approved').click(function() {
            let final_amount = $("#final_amount").val().trim();
            let correctness_remarks = $("#correctness_remarks").val().trim();
            let status = 1; 
              if (final_amount === "") {  
                $("#amount_error").text("Please enter Amount");
                $("#remarks_error").text("");
                $(".input-group").addClass("has-error");
                event.preventDefault();
              } else {
                $("#amount_error").text("");
                $("#remarks_error").text("");
                $(".input-group").removeClass("has-error");
                tev_details(final_amount,correctness_remarks,status,clicked_id);
              }
          });
          
          $('#returned').click(function() {
            let final_amount = $("#final_amount").val().trim();
            let correctness_remarks = $("#correctness_remarks").val().trim();
            let status = 2;
              if (correctness_remarks === "") {
                $("#amount_error").text("");
                $("#remarks_error").text("Please enter Remarks for returned.");
                $(".input-group").addClass("has-error");
                event.preventDefault();
              } else {
                $("#remarks_error").text("");
                $(".input-group").removeClass("has-error");
                tev_details(final_amount,correctness_remarks,status,clicked_id);
              }
              
            });

        function tev_details(amount,remarks,status,emp_id){
            $.ajax({
                type: "POST",
                data:{
                    final_amount: amount,
                    correctness_remarks: remarks,
                    status : status,
                    transaction_id : emp_id
                }
                }).done(function(data){
                if (data.data == 'success') {
                    toastr.success('Successfully save', 'Success', toast_options);
                    offCanvasEl.hide()
                } else {
                    toastr.danger('Data not saved', 'Danger', toast_options);
                }
            });
            }
    })
</script>
{% endblock footer_scripts %}
